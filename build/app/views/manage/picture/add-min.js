KISSY.add("app/views/manage/picture/add",function(e,a,i,t,n,l,r,c){var o=r.all;return function(e){return e.prototype.template='<h2 class=h2-ex>\u56fe\u7247\u4e0a\u4f20</h2> <div class=pic-upload-cnt> <ul class=clearfix bx-tmpl="pics" bx-datakey="pics"> {{#pics}} <li> <div class=pic-cnt> <img src="{{filePath}}"  /> </div> <div class=meta> <div class="progress progress{{__index__}}"></div> {{fileSize}} </div> </li> {{/pics}} </ul> <div class=pic-upload-input> <input type=file name=upload id=J_upload multiple=multiple mx-change=fileChange  /> </div> </div> <p> <a href="javascript:;" class="btn btn-small mr10" mx-click=upload>\u4e0a\u4f20</a> <a href="javascript:;" mx-click=cancel>\u53d6\u6d88</a> </p>',e}(a.extend({init:function(e){this.manage("data",e)},locationChange:function(){this.render()},render:function(){var e=this;e.setViewPagelet({pics:[]},function(){e.components()})},components:function(){},picPreview:function(e){for(var a=this,i=a.getManaged("pagelet"),t=e.length,n=[],l=0;t>l;l++){var r=e[l],c={};if(r){c.fileSize=r.size>1048576?(Math.round(100*r.size/1048576)/100).toString()+"MB":(Math.round(100*r.size/1024)/100).toString()+"KB"}if(0==r.type.indexOf("image")){var o=new FileReader;o.readAsDataURL?o.readAsDataURL(r):o.readAsDataurl&&o.readAsDataurl(r),function(e,a){o.onload=function(l){e.filePath=l.target.result,n.push(e),a==t-1&&i.setChunkData("pics",n)}}(c,l)}}},uploadFile:function(e){function a(){if(d<e.length&&d!=e.length){var a=new FormData;a.append("pic",e[d]);var c=new XMLHttpRequest;c.upload.addEventListener("progress",i,!1),c.addEventListener("load",n,!1),c.addEventListener("error",l,!1),c.addEventListener("abort",r,!1),c.open("POST","/api/tool/pic/create.json?_csrf="+t.local("csrf")),c.send(a)}}function i(e){if(e.lengthComputable){var a=Math.round(100*e.loaded/e.total),i=o(".progress"+d);i.html('<div style="width:'+a.toString()+'%;"></div>')}}function n(){d++,a(),d==e.length&&(c.hideDialog(),s.getManaged("data").callback())}function l(){}function r(){}var s=this,d=(s.getManaged("pagelet"),0);a()},"fileChange<change>":function(e){e.halt();var a=this,i=o("#J_upload")[0].files;a.picPreview(i)},"upload<click>":function(e){e.halt();var a=this,i=o("#J_upload")[0].files;a.uploadFile(i)},"cancel<click>":function(){c.hideDialog()}}))},{requires:["mxext/view","app/models/modelmanager","magix/magix","magix/vom","magix/router","node","app/util/util"]});